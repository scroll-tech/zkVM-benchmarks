#!/bin/bash
set -euxo pipefail

# Prep
(
  (
    cd ceno/examples
    cargo build --release --example=quadratic_sorting
  )
  (
    cd ceno
    cargo build --release --bin e2e
  )

  mkdir --parents sorting-output/ceno
  mkdir --parents sorting-output/sp1
)

(
  cd sorting/program
  cargo prove build
)
export MAX=12000
# export MAX="$((1 << 14))"

for N in $(shuf --input-range=1-${MAX}); do
  for system in $(shuf --echo ceno sp1); do
    output="sorting-output/${N}-$(date --iso-8601=ns --utc)/${system}"
    mkdir --parents "${output}"
    ./run_${system}_sorting "${N}" "${output}"

  done

done

output="output_time"

(
  cd sorting/script

  # export RUSTFLAGS="-C target-cpu=native -C target-feature=+avx512f"
  # export RUSTFLAGS="-C target-cpu=native"
  export RUST_LOG=info
  # cargo clean
  cargo build --release --bin sorting
  /usr/bin/time --verbose --output="${output}" -- cargo run --release -- --n=$N --prove
  echo "RUSTFLAGS=\'${RUSTFLAGS:-}\'"
  echo "N=\'${N}'"
  cat "${output}"
)
